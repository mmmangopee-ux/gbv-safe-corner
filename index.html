<!DOCTYPE html>
<html lang="en">
<head>
    <title>GBV Safe Corner - AI Support & Emergency Help</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6A0DAD">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Enhanced Analytics -->
    <script src="analytics.js"></script>
    <script src="navigation.js"></script>
    
    <!-- AI Support System -->
    <script src="ai-support.js"></script>
    
    <!-- Emergency Services Integration -->
    <script src="emergency-services.js"></script>

    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        :root {
            --primary: #6A0DAD;
            --primary-dark: #5a0a9a;
            --primary-light: #8A2BE2;
            --secondary: #2196F3;
            --accent: #FF6B6B;
            --success: #4CAF50;
            --warning: #FF9800;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #6c757d;
            --shadow: 0 8px 30px rgba(0,0,0,0.12);
            --radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f4fd 100%);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Enhanced Header */
        .main-header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* AI Support Chat Interface */
        .ai-support-widget {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 600px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 1002;
            display: none;
            flex-direction: column;
            transition: var(--transition);
        }

        .ai-support-visible {
            display: flex;
            animation: slideUp 0.4s ease-out;
        }

        .ai-chat-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: var(--light);
        }

        .message {
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            max-width: 85%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.ai {
            background: white;
            border: 1px solid #e1e8ed;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .message.emergency {
            background: linear-gradient(135deg, var(--accent), #ff5252);
            color: white;
            border: none;
            animation: pulse 2s infinite;
        }

        .ai-chat-input {
            display: flex;
            padding: 1.25rem;
            border-top: 1px solid #e1e8ed;
            background: white;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .ai-chat-input input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e1e8ed;
            border-radius: 25px;
            margin-right: 0.75rem;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .ai-chat-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 13, 173, 0.1);
        }

        /* Quick Action Buttons */
        .quick-actions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .quick-action-btn {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 1rem;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(106, 13, 173, 0.3);
        }

        /* Emergency Services Map */
        .emergency-map {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .map-placeholder {
            height: 300px;
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-weight: 600;
        }

        /* Safety Tools */
        .safety-tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .safety-tool-card {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .safety-tool-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 12px 35px rgba(106, 13, 173, 0.15);
        }

        .tool-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Enhanced Emergency Bar */
        .emergency-bar {
            background: linear-gradient(135deg, var(--accent), #ff5252);
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(255, 107, 107, 0.4);
        }

        .emergency-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .emergency-btn:hover {
            background: white;
            color: var(--accent);
            transform: scale(1.05);
        }

        /* AI Support Trigger */
        .ai-support-trigger {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 1001;
            transition: var(--transition);
            animation: pulse 2s infinite;
        }

        .ai-support-trigger:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(106, 13, 173, 0.4);
        }

        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .ai-support-widget {
                width: 100vw;
                height: 100vh;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }

            .ai-support-trigger {
                bottom: 100px;
                right: 20px;
                width: 60px;
                height: 60px;
            }

            .emergency-bar {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
            }

            .quick-actions-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .safety-tools-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: #e0e0e0;
            }

            .ai-support-widget,
            .safety-tool-card,
            .emergency-map {
                background: #2d3748;
                color: #e0e0e0;
            }

            .message.ai {
                background: #4a5568;
                color: #e0e0e0;
                border-color: #4a5568;
            }

            .ai-chat-input input {
                background: #4a5568;
                border-color: #4a5568;
                color: #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo">
                <span>üõ°Ô∏è</span>
                GBV Safe Corner
            </div>
            <nav class="main-nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="community.html" class="nav-link">Community</a>
                <a href="support.html" class="nav-link">Support</a>
                <a href="resources.html" class="nav-link">Resources</a>
            </nav>
        </div>
    </header>

    <!-- AI Support Widget -->
    <div class="ai-support-widget" id="aiSupportWidget">
        <div class="ai-chat-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="ai-avatar">ü§ñ</div>
                <div>
                    <h3 style="margin: 0;">Hope AI Assistant</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">24/7 Emotional Support</p>
                </div>
            </div>
            <button class="close-btn" onclick="closeAIChat()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>
        </div>
        
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="message ai">
                <strong>Hope AI:</strong> Hello, I'm here to support you. This is a safe space. How can I help you today?
            </div>
            <div class="message emergency">
                <strong>‚ö†Ô∏è Emergency:</strong> If you're in immediate danger, please call 10111 or use the emergency button below.
            </div>
        </div>
        
        <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="Type your message... (I'm here to listen)" onkeypress="handleAIInput(event)">
            <button class="emergency-btn" onclick="sendAIMessage()" style="padding: 0.75rem 1.5rem;">Send</button>
        </div>
    </div>

    <!-- AI Support Trigger -->
    <div class="ai-support-trigger" onclick="toggleAIChat()">
        <span style="font-size: 1.5rem;">üí¨</span>
    </div>

    <!-- Main Content -->
    <main style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
        <!-- Quick Actions -->
        <section>
            <h2 style="margin-bottom: 1.5rem; color: var(--primary);">Quick Safety Actions</h2>
            <div class="quick-actions-container">
                <div class="quick-action-btn" onclick="triggerEmergencyProtocol()">
                    <span style="font-size: 2rem;">üö®</span>
                    Emergency Help
                </div>
                <div class="quick-action-btn" onclick="findSafeLocation()">
                    <span style="font-size: 2rem;">üìç</span>
                    Find Safe Place
                </div>
                <div class="quick-action-btn" onclick="startSafetyPlan()">
                    <span style="font-size: 2rem;">üõ°Ô∏è</span>
                    Safety Plan
                </div>
                <div class="quick-action-btn" onclick="connectToCounselor()">
                    <span style="font-size: 2rem;">üë©‚Äçüíº</span>
                    Live Counselor
                </div>
            </div>
        </section>

        <!-- Emergency Services Map -->
        <section class="emergency-map">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary);">Nearby Emergency Services</h2>
            <div class="map-placeholder" id="emergencyMap">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                    <p>Loading safe locations near you...</p>
                    <button class="emergency-btn" onclick="loadUserLocation()" style="margin-top: 1rem; background: var(--primary); color: white; border: none;">
                        Enable Location Services
                    </button>
                </div>
            </div>
        </section>

        <!-- Safety Tools -->
        <section>
            <h2 style="margin-bottom: 1.5rem; color: var(--primary);">Safety & Protection Tools</h2>
            <div class="safety-tools-grid">
                <div class="safety-tool-card">
                    <div class="tool-icon">üì±</div>
                    <h3>Fake Call Generator</h3>
                    <p>Schedule emergency exit calls to leave uncomfortable situations safely</p>
                    <button class="emergency-btn" onclick="startFakeCall()" style="margin-top: 1rem; background: var(--primary); color: white; border: none;">
                        Set Up Fake Call
                    </button>
                </div>
                
                <div class="safety-tool-card">
                    <div class="tool-icon">üîí</div>
                    <h3>Digital Safety Scan</h3>
                    <p>Check your device for tracking software and secure your digital footprint</p>
                    <button class="emergency-btn" onclick="startSafetyScan()" style="margin-top: 1rem; background: var(--primary); color: white; border: none;">
                        Scan Device
                    </button>
                </div>
                
                <div class="safety-tool-card">
                    <div class="tool-icon">üìù</div>
                    <h3>Incident Logger</h3>
                    <p>Securely document incidents with timestamp and location data</p>
                    <button class="emergency-btn" onclick="startIncidentLog()" style="margin-top: 1rem; background: var(--primary); color: white; border: none;">
                        Log Incident
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Emergency Bar -->
    <div class="emergency-bar">
        <div>üö® 24/7 EMERGENCY: GBV Command Centre 0800 428 428 ‚Ä¢ Police 10111</div>
        <button class="emergency-btn" onclick="emergencyRedirect()">Quick Exit & Get Help</button>
    </div>

    <script>
        // AI Support System
        const aiSupport = {
            isOpen: false,
            conversation: [],
            emergencyKeywords: ['help', 'emergency', 'danger', 'hurt', 'scared', 'suicide', 'abuse'],
            
            init() {
                this.loadConversation();
                this.setupAIResponses();
            },
            
            toggleChat() {
                const widget = document.getElementById('aiSupportWidget');
                this.isOpen = !this.isOpen;
                
                if (this.isOpen) {
                    widget.classList.add('ai-support-visible');
                    document.getElementById('aiChatInput').focus();
                } else {
                    widget.classList.remove('ai-support-visible');
                }
            },
            
            sendMessage() {
                const input = document.getElementById('aiChatInput');
                const message = input.value.trim();
                
                if (message) {
                    this.addMessage(message, 'user');
                    this.processUserMessage(message);
                    input.value = '';
                }
            },
            
            addMessage(text, sender) {
                const messagesContainer = document.getElementById('aiChatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                if (sender === 'user') {
                    messageDiv.innerHTML = `<strong>You:</strong> ${this.sanitizeText(text)}`;
                } else if (sender === 'ai') {
                    messageDiv.innerHTML = `<strong>Hope AI:</strong> ${text}`;
                } else if (sender === 'emergency') {
                    messageDiv.innerHTML = `<strong>‚ö†Ô∏è Emergency:</strong> ${text}`;
                }
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Save to conversation history
                this.conversation.push({ sender, text, timestamp: new Date() });
                this.saveConversation();
            },
            
            processUserMessage(message) {
                const lowerMessage = message.toLowerCase();
                
                // Check for emergency keywords
                if (this.emergencyKeywords.some(keyword => lowerMessage.includes(keyword))) {
                    this.handleEmergencySituation(message);
                    return;
                }
                
                // Generate AI response
                setTimeout(() => {
                    const response = this.generateAIResponse(message);
                    this.addMessage(response, 'ai');
                }, 1000);
            },
            
            generateAIResponse(message) {
                const responses = {
                    greeting: [
                        "I'm here to listen. You're in a safe space. How are you feeling right now?",
                        "Thank you for reaching out. I'm here to support you. What's on your mind?",
                        "Hello, I'm Hope. This is a judgment-free zone. How can I help you today?"
                    ],
                    support: [
                        "That sounds really difficult. You're showing courage by talking about it.",
                        "I understand this must be painful. Remember, you're not alone in this.",
                        "Thank you for sharing that with me. It takes strength to open up."
                    ],
                    resources: [
                        "Would you like me to connect you with a professional counselor?",
                        "I can help you find local support services in your area.",
                        "There are trained professionals available 24/7 who can provide immediate support."
                    ],
                    default: [
                        "I'm here to listen and support you. Could you tell me more about what you're experiencing?",
                        "Your feelings are valid. Would you like to talk more about what's happening?",
                        "I understand this is difficult. Remember, reaching out for help is a sign of strength."
                    ]
                };
                
                // Simple keyword-based response selection
                if (message.match(/\b(hi|hello|hey)\b/i)) {
                    return this.getRandomResponse(responses.greeting);
                } else if (message.match(/\b(sad|hurt|scared|anxious|worried)\b/i)) {
                    return this.getRandomResponse(responses.support);
                } else if (message.match(/\b(help|support|counselor|therapist)\b/i)) {
                    return this.getRandomResponse(responses.resources);
                } else {
                    return this.getRandomResponse(responses.default);
                }
            },
            
            handleEmergencySituation(message) {
                // Immediate emergency response
                this.addMessage("I've detected this might be an emergency situation. Please know that help is available immediately.", 'emergency');
                this.addMessage("Call 10111 for police or 0800 428 428 for GBV emergency support. Would you like me to connect you to a live counselor right now?", 'emergency');
                
                // Trigger emergency protocols
                this.triggerEmergencySupport();
            },
            
            triggerEmergencySupport() {
                // Show emergency contact overlay
                const emergencyContacts = [
                    { name: "Police Emergency", number: "10111" },
                    { name: "GBV Command Centre", number: "0800 428 428" },
                    { name: "Lifeline Counseling", number: "0861 322 322" },
                    { name: "Suicide Crisis Line", number: "0800 567 567" }
                ];
                
                let emergencyHTML = "<div style='background: #fff3f3; padding: 1rem; border-radius: 8px; margin: 1rem 0;'>";
                emergencyHTML += "<h4 style='color: #d32f2f; margin-bottom: 0.5rem;'>üö® Immediate Emergency Contacts:</h4>";
                emergencyContacts.forEach(contact => {
                    emergencyHTML += `<p style='margin: 0.25rem 0;'><strong>${contact.name}:</strong> <a href="tel:${contact.number}" style="color: #d32f2f; text-decoration: none; font-weight: bold;">${contact.number}</a></p>`;
                });
                emergencyHTML += "</div>";
                
                const messagesContainer = document.getElementById('aiChatMessages');
                const emergencyDiv = document.createElement('div');
                emergencyDiv.innerHTML = emergencyHTML;
                messagesContainer.appendChild(emergencyDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            },
            
            getRandomResponse(responses) {
                return responses[Math.floor(Math.random() * responses.length)];
            },
            
            sanitizeText(text) {
                // Basic sanitization to prevent XSS
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            saveConversation() {
                localStorage.setItem('aiConversation', JSON.stringify(this.conversation));
            },
            
            loadConversation() {
                const saved = localStorage.getItem('aiConversation');
                if (saved) {
                    this.conversation = JSON.parse(saved);
                    // Optionally reload conversation UI
                }
            },
            
            setupAIResponses() {
                // Pre-load common emergency resources
                console.log("AI Support System Initialized");
            }
        };

        // Global Functions
        function toggleAIChat() {
            aiSupport.toggleChat();
        }

        function closeAIChat() {
            aiSupport.isOpen = false;
            document.getElementById('aiSupportWidget').classList.remove('ai-support-visible');
        }

        function sendAIMessage() {
            aiSupport.sendMessage();
        }

        function handleAIInput(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        function emergencyRedirect() {
            if (confirm('This will immediately clear your browsing history and redirect to a safe page. Continue?')) {
                // Clear sensitive data
                localStorage.removeItem('aiConversation');
                sessionStorage.clear();
                
                // Redirect to safe page
                window.location.href = 'https://www.google.com/search?q=weather+South+Africa';
            }
        }

        function triggerEmergencyProtocol() {
            aiSupport.toggleChat();
            aiSupport.addMessage("I need emergency help immediately!", 'user');
            aiSupport.handleEmergencySituation("emergency");
        }

        function findSafeLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        alert(`üìç Finding safe locations near you...\nCoordinates: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}\n\nThis would show nearby police stations, shelters, and hospitals.`);
                    },
                    error => {
                        alert('üìç Please enable location services to find safe places near you.');
                    }
                );
            } else {
                alert('üìç Location services not available on this device.');
            }
        }

        function startSafetyPlan() {
            alert('üõ°Ô∏è Opening Safety Planning Tool...\n\nThis helps you create a personalized safety plan for different situations.');
        }

        function connectToCounselor() {
            alert('üë©‚Äçüíº Connecting you with a trained counselor...\n\nYou will be connected to a professional who can provide immediate support.');
        }

        function loadUserLocation() {
            findSafeLocation();
        }

        function startFakeCall() {
            const minutes = prompt('Set fake call in how many minutes? (1-10)', '3');
            if (minutes && minutes > 0 && minutes <= 10) {
                alert(`üì± Fake call scheduled in ${minutes} minutes.\n\nYour phone will ring with a fake "Emergency" call to help you exit safely.`);
            }
        }

        function startSafetyScan() {
            alert('üîí Starting digital safety scan...\n\nChecking for tracking software and securing your digital privacy.');
        }

        function startIncidentLog() {
            alert('üìù Opening secure incident logger...\n\nThis tool helps you document incidents with timestamps and location data.');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            aiSupport.init();
            
            // PWA Installation Prompt
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered for offline support'))
                    .catch(error => console.log('SW registration failed'));
            }
            
            // Enhanced analytics
            if (typeof analytics !== 'undefined') {
                analytics.trackPageView('enhanced-homepage');
                analytics.trackFeatureUse('ai_support_loaded');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAIChat();
            }
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                toggleAIChat();
            }
        });
    </script>
</body>
</html>
