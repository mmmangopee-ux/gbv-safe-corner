<!DOCTYPE html>
<html>
<head>
    <title>Admin - GBV Safe Corner</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f8f8f8; }
        .header { 
            background: linear-gradient(135deg, #6A0DAD, #8A2BE2);
            color: white; 
            padding: 20px; 
            text-align: center; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        .logo-text {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            line-height: 1.2;
            margin-bottom: 10px;
        }
        .logo-text span {
            display: block;
        }
        .admin-section { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0; 
            box-shadow: 0 2px 5px rgba(106, 13, 173, 0.1);
        }
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 15px 0; 
        }
        .data-table th, .data-table td { 
            border: 1px solid #ddd; 
            padding: 10px; 
            text-align: left; 
        }
        .data-table th { 
            background: #6A0DAD; 
            color: white; 
        }
        .data-table tr:nth-child(even) { 
            background: #f9f9f9; 
        }
        .tab-buttons { 
            display: flex; 
            margin-bottom: 20px; 
        }
        .tab-btn { 
            padding: 10px 20px; 
            background: #ddd; 
            border: none; 
            cursor: pointer; 
            margin-right: 5px; 
            transition: all 0.3s ease;
        }
        .tab-btn.active { 
            background: #6A0DAD; 
            color: white; 
        }
        .tab-btn:hover {
            background: #6A0DAD;
            color: white;
        }
        .tab-content { 
            display: none; 
        }
        .tab-content.active { 
            display: block; 
        }
        .refresh-btn { 
            background: #6A0DAD; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-bottom: 15px; 
            transition: background 0.3s ease;
        }
        .refresh-btn:hover {
            background: #8A2BE2;
        }
        .logout-btn { 
            background: #666; 
            color: white; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            position: absolute; 
            top: 20px; 
            right: 20px; 
        }
        .purple-accent {
            color: #6A0DAD;
        }
        .security-notice {
            background: #e8f4fd;
            border-left: 4px solid #6A0DAD;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <button class="logout-btn" onclick="logout()">Logout</button>

    <div class="header">
        <div class="logo-text">
            <span>GBV</span>
            <span>SAFE</span>
            <span>CORNER</span>
        </div>
        <p>Secure Admin Panel - Private Data Access</p>
    </div>

    <div class="security-notice">
        <strong>ðŸ”’ Security Notice:</strong> Reports are completely private and only visible in this admin panel. 
        The public cannot access any report data.
    </div>

    <div class="tab-buttons">
        <button class="tab-btn active" onclick="showTab('reports')">Private Reports</button>
        <button class="tab-btn" onclick="showTab('stories')">Anonymous Stories</button>
        <button class="tab-btn" onclick="showTab('events')">Public Events</button>
    </div>

    <div id="reports" class="tab-content active">
        <div class="admin-section">
            <h2 class="purple-accent">ðŸ”’ Private Reports (Admin Only)</h2>
            <p><em>These reports are completely hidden from public view for survivor safety.</em></p>
            <button class="refresh-btn" onclick="loadReports()">Refresh Private Reports</button>
            <div id="reportsData"></div>
        </div>
    </div>

    <div id="stories" class="tab-content">
        <div class="admin-section">
            <h2 class="purple-accent">ðŸ“– Anonymous Stories</h2>
            <p><em>Only stories marked for anonymous sharing are visible to the public.</em></p>
            <button class="refresh-btn" onclick="loadStories()">Refresh Stories</button>
            <div id="storiesData"></div>
        </div>
    </div>

    <div id="events" class="tab-content">
        <div class="admin-section">
            <h2 class="purple-accent">ðŸ“… Public Events</h2>
            <p><em>Only events marked as public are visible on the main website.</em></p>
            <button class="refresh-btn" onclick="loadEvents()">Refresh Events</button>
            <div id="eventsData"></div>
        </div>
    </div>

    <script>
        (function() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            const loginTime = localStorage.getItem('loginTime');
            const currentTime = new Date().getTime();
            const hoursSinceLogin = loginTime ? (currentTime - loginTime) / (1000 * 60 * 60) : 0;

            if (!isLoggedIn || hoursSinceLogin >= 24) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('loginTime');
                window.location.href = 'login.html';
                return;
            }
        })();

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('loginTime');
            window.location.href = 'login.html';
        }

        const SUPABASE_URL = 'https://sofzsursxpjmghhcphrh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNvZnpzdXJzeHBqbWdoaGNwaHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTIwNTMsImV4cCI6MjA3OTE2ODA1M30.nW5ylZoVNeJAegTXqx_x0bjb1lSOsvMBnhsScYR8hf8';

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function fetchFromSupabase(tableName, options = {}) {
            try {
                let url = SUPABASE_URL + '/rest/v1/' + tableName;
                
                if (options.query) {
                    url += '?' + new URLSearchParams(options.query).toString();
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error(`Error fetching from ${tableName}:`, error);
                throw error;
            }
        }

        async function loadReports() {
            try {
                document.getElementById('reportsData').innerHTML = '<p>Loading private reports...</p>';
                
                const reports = await fetchFromSupabase('gbv_reports', {
                    query: { order: 'created_at.desc' }
                });
                
                if (reports.length === 0) {
                    document.getElementById('reportsData').innerHTML = `
                        <p>No private reports found.</p>
                        <div class="security-notice">
                            <strong>Note:</strong> Reports are completely private. The public cannot see any report data.
                            Submit a test report through the website to verify the system is working.
                        </div>
                    `;
                    return;
                }
                
                let html = `<table class="data-table">
                    <tr>
                        <th>Date Submitted</th>
                        <th>Incident Type</th>
                        <th>Location</th>
                        <th>Description</th>
                        <th>Needs Support</th>
                    </tr>`;
                
                reports.forEach(report => {
                    html += `<tr>
                        <td>${new Date(report.created_at).toLocaleString()}</td>
                        <td>${report.incident_type || 'Not specified'}</td>
                        <td>${report.location || 'Not specified'}</td>
                        <td>${report.description || 'No description provided'}</td>
                        <td>${report.needs_support ? 'âœ… Yes' : 'No'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                document.getElementById('reportsData').innerHTML = html;
            } catch (error) {
                document.getElementById('reportsData').innerHTML = `
                    <p>Error loading private reports: ${error.message}</p>
                    <div class="security-notice">
                        <strong>Solution Needed:</strong> Run the RLS SQL commands in Supabase to enable private report access.
                    </div>
                `;
            }
        }

        async function loadStories() {
            try {
                document.getElementById('storiesData').innerHTML = '<p>Loading stories...</p>';
                const stories = await fetchFromSupabase('survivor_stories', {
                    query: { order: 'created_at.desc' }
                });
                
                let html = `<table class="data-table">
                    <tr>
                        <th>Date</th>
                        <th>Title</th>
                        <th>Story Preview</th>
                        <th>Anonymous</th>
                        <th>Allow Comments</th>
                    </tr>`;
                
                stories.forEach(story => {
                    const preview = story.story_content ? 
                        (story.story_content.substring(0, 100) + '...') : 'No content';
                    
                    html += `<tr>
                        <td>${new Date(story.created_at).toLocaleDateString()}</td>
                        <td>${story.story_title || 'Untitled'}</td>
                        <td>${preview}</td>
                        <td>${story.share_anonymously ? 'âœ… Yes' : 'No'}</td>
                        <td>${story.allow_comments ? 'âœ… Yes' : 'No'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                document.getElementById('storiesData').innerHTML = html || '<p>No stories found.</p>';
            } catch (error) {
                document.getElementById('storiesData').innerHTML = `<p>Error loading stories: ${error.message}</p>`;
            }
        }

        async function loadEvents() {
            try {
                document.getElementById('eventsData').innerHTML = '<p>Loading events...</p>';
                const events = await fetchFromSupabase('gbv_events', {
                    query: { order: 'created_at.desc' }
                });
                
                let html = `<table class="data-table">
                    <tr>
                        <th>Date Submitted</th>
                        <th>Event Name</th>
                        <th>Event Type</th>
                        <th>Event Date</th>
                        <th>Location</th>
                        <th>Organizer Contact</th>
                        <th>Public</th>
                    </tr>`;
                
                events.forEach(event => {
                    html += `<tr>
                        <td>${new Date(event.created_at).toLocaleDateString()}</td>
                        <td>${event.event_name}</td>
                        <td>${event.event_type}</td>
                        <td>${event.event_date ? new Date(event.event_date).toLocaleDateString() : 'Not set'}</td>
                        <td>${event.location}</td>
                        <td>${event.organizer_contact}</td>
                        <td>${event.is_public ? 'âœ… Yes' : 'No'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                document.getElementById('eventsData').innerHTML = html || '<p>No events found.</p>';
            } catch (error) {
                document.getElementById('eventsData').innerHTML = `<p>Error loading events: ${error.message}</p>`;
            }
        }

        // Load initial data
        loadReports();
    </script>
</body>
</html>
